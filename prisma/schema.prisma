// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model UserSettings {
  id               String   @id @default(uuid())
  userId           String   @unique // Clerk User ID
  telegramChatId   String?  @unique // Linked Telegram Chat ID
  monthlyBudget    Float    @default(0)
  currency         String   @default("INR")
  dashboardWidgets Json?    // Stores which dashboard widgets to show/hide
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model Expense {
  id            String         @id @default(uuid())
  userId        String         // Clerk User ID
  amount        Float
  category      String         @default("General")
  merchant      String?
  description   String?
  source        Source         @default(WEB)
  paymentMethod String?        // Account name label (for display)
  accountId     String?        // Linked account for balance tracking
  account       Account?       @relation(fields: [accountId], references: [id], onDelete: SetNull)
  date          DateTime       @default(now())
  isVerified    Boolean        @default(false) // True if matched with Bank Statement
  metadata      Json?          // Stores raw OCR text or debug info
  receiptUrl    String?        // Legacy single receipt URL (deprecated)
  receiptUrls   String[]       @default([]) // URLs to receipts/invoices stored in Cloudflare R2
  createdAt     DateTime       @default(now())

  @@index([userId])
  @@index([date])
  @@index([accountId])
}

model LinkingCode {
  id        String   @id @default(uuid())
  userId    String   // Clerk User ID
  code      String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([code])
}

enum Source {
  TELEGRAM
  STATEMENT
  WEB
}

enum BillingCycle {
  ONCE
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

model Subscription {
  id            String       @id @default(uuid())
  userId        String       // Clerk User ID
  name          String       // e.g., "Netflix", "Spotify"
  amount        Float
  billingCycle  BillingCycle @default(MONTHLY)
  nextBillingDate DateTime
  paymentMethod String?       // Account name (dynamic, from user's accounts)
  category      String       @default("Subscription")
  description   String?
  isActive      Boolean      @default(true)
  alertDaysBefore Int        @default(3) // Days before to send reminder
  lastAlertSent DateTime?    // Track when last alert was sent
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([userId])
  @@index([nextBillingDate])
}

enum LoanStatus {
  PENDING      // Not yet fully repaid
  PARTIAL      // Partially repaid
  COMPLETED    // Fully repaid
}

model Loan {
  id            String       @id @default(uuid())
  userId        String       // Clerk User ID (lender)
  borrowerName  String       // Name of person who borrowed
  borrowerPhone String?      // Optional contact
  amount        Float        // Total amount lent
  amountRepaid  Float        @default(0) // Amount repaid so far
  status        LoanStatus   @default(PENDING)
  lendDate      DateTime     @default(now())
  dueDate       DateTime?    // Optional due date
  description   String?      // Notes about the loan
  receiptUrls   String[]     @default([]) // Receipts/proof
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  repayments    Repayment[]

  @@index([userId])
  @@index([borrowerName])
}

model Repayment {
  id          String   @id @default(uuid())
  loanId      String
  loan        Loan     @relation(fields: [loanId], references: [id], onDelete: Cascade)
  amount      Float
  date        DateTime @default(now())
  note        String?
  receiptUrls String[] @default([]) // Receipts for this repayment
  createdAt   DateTime @default(now())

  @@index([loanId])
}

enum AccountType {
  BANK
  INVESTMENT
  WALLET
  CASH
  CREDIT_CARD
  DEBIT_CARD
  OTHER
}

model Account {
  id            String          @id @default(uuid())
  userId        String          // Clerk User ID
  name          String          // e.g., "SBI Savings", "Zerodha", "PPF"
  type          AccountType     @default(BANK)
  currentBalance Float          @default(0)
  description   String?
  icon          String?         // Optional icon identifier
  color         String?         // Optional color for UI
  creditLimit   Float?          // Credit limit (for CREDIT_CARD accounts)
  isActive      Boolean         @default(true)
  showOnTelegram Boolean        @default(true) // Whether to show in Telegram bot payment options
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  balanceHistory BalanceHistory[]
  expenses      Expense[]

  @@index([userId])
  @@index([type])
}

model BalanceHistory {
  id        String   @id @default(uuid())
  accountId String
  account   Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  balance   Float
  note      String?  // Optional note for this update
  date      DateTime @default(now())
  createdAt DateTime @default(now())

  @@index([accountId])
  @@index([date])
}
